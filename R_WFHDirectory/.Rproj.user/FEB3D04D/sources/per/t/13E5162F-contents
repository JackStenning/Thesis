if (!require("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

#BiocManager::install("TxDb.Hsapiens.UCSC.hg38.knownGene")
#BiocManager::install("ChIPseeker")
#BiocManager::install("EnsDb.Hsapiens.v86")
#BiocManager::install("clusterProfiler")
#BiocManager::install("AnnotationDbi")
#BiocManager::install("org.Hs.eg.db")


# Load libraries
library(ChIPseeker)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(EnsDb.Hsapiens.v86)
library(clusterProfiler)
library(AnnotationDbi)
library(org.Hs.eg.db)
library(dplyr)

#Set working directory
setwd("//userfs/jps558/w2k/Desktop/R_WorkingDirectory") 

#Load data
samplefiles <- list.files("peaks/", pattern='.bed', full.names = T)
samplefiles <- as.list(samplefiles)
names(samplefiles) <- c("Peakset1", "Peakset2", "Peakset3")

txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

#Get Annotations
peakAnnoList <- lapply(samplefiles, annotatePeak, TxDb=txdb, 
                       tssRegion=c(-1000, 1000), verbose=FALSE)
peakAnnoList

#Plot data barchart
plotAnnoBar(peakAnnoList)

#Distance to TSS
plotDistToTSS(peakAnnoList, title="Distribution of transcription factor-binding loci \n relative to TSS")

#Annotations for each peakset
Set1_annot <- data.frame(peakAnnoList[["Peakset1"]]@anno)
Set2_annot <- data.frame(peakAnnoList[["Peakset2"]]@anno)
Set3_annot <- data.frame(peakAnnoList[["Peakset3"]]@anno)

#Map EntrezID symbols
#Get IDs
entrez1 <- Set1_annot$geneId
entrez2 <- Set2_annot$geneId
entrez3 <- Set3_annot$geneId

#Return gene symbol
annotations_ebd1 <- AnnotationDbi::select(EnsDb.Hsapiens.v86,
                                          keys = entrez1,
                                          columns = c("GENENAME"),
                                          keytype = "ENTREZID")
annotations_ebd2 <- AnnotationDbi::select(EnsDb.Hsapiens.v86,
                                          keys = entrez2,
                                          columns = c("GENENAME"),
                                          keytype = "ENTREZID")
annotations_ebd3 <- AnnotationDbi::select(EnsDb.Hsapiens.v86,
                                          keys = entrez3,
                                          columns = c("GENENAME"),
                                          keytype = "ENTREZID")


#Change IDs to Character type to merge
annotations_ebd1$ENTREZID <- as.character(annotations_ebd1$ENTREZID)

  
annotations_ebd2$ENTREZID <- as.character(annotations_ebd2$ENTREZID)


annotations_ebd3$ENTREZID <- as.character(annotations_ebd3$ENTREZID)

#Write to file
Set1_annot %>%
  left_join(annotations_ebd1, by=c("geneId"="ENTREZID")) %>% 
  write.table(file="output/Set1_PeakAnnotation.txt", sep="\t", quote=F, row.names=F)
Set2_annot %>%
  left_join(annotations_ebd2, by=c("geneId"="ENTREZID")) %>% 
  write.table(file="output/Set2_PeakAnnotation.txt", sep="\t", quote=F, row.names=F)
Set3_annot %>%
  left_join(annotations_ebd3, by=c("geneId"="ENTREZID")) %>% 
  write.table(file="output/Set3_PeakAnnotation.txt", sep="\t", quote=F, row.names=F)

#Overrepresentation of Gene ontology terms
ego1 <- enrichGO(gene=entrez1,
                 keyType = "ENTREZID",
                 OrgDb = org.Hs.eg.db,
                 ont = "BP",
                 pAdjustMethod = "BH",
                 qvalueCutoff = 0.05,
                 readable = TRUE)
ego2 <- enrichGO(gene=entrez2,
                 keyType = "ENTREZID",
                 OrgDb = org.Hs.eg.db,
                 ont = "BP",
                 pAdjustMethod = "BH",
                 qvalueCutoff = 0.05,
                 readable = TRUE)
ego3 <- enrichGO(gene=entrez3,
                 keyType = "ENTREZID",
                 OrgDb = org.Hs.eg.db,
                 ont = "BP",
                 pAdjustMethod = "BH",
                 qvalueCutoff = 0.05,
                 readable = TRUE)

#Output results to table
cluster_summary1 <- data.frame(ego1)
write.csv(cluster_summary1, "output/ClusterProfiler_set1.csv")

cluster_summary2 <- data.frame(ego2)
write.csv(cluster_summary2, "output/ClusterProfiler_set2.csv")

cluster_summary3 <- data.frame(ego3)
write.csv(cluster_summary3, "output/ClusterProfiler_set3.csv")

#Dot Plot visualisation
dotplot(ego3, showCategory=50)


#KEGG
ekegg3 <- enrichKEGG(gene = entrez3,
                     organism = 'hsa',
                     pvalueCutoff = 0.05)
dotplot(ekegg3)


