df_vehicle <- slopes_df %>%
filter(Metric == metric,
TreatmentGroup == "Vehicle")
if(nrow(df_treat) > 0 & nrow(df_vehicle) > 0){
df_sub <- bind_rows(df_treat, df_vehicle)
df_sub$TreatmentGroup <- factor(df_sub$TreatmentGroup, levels=c("Vehicle","EF5"))
ttest <- t.test(Slope ~ TreatmentGroup, data=df_sub)
comparison_results[[paste(metric, day)]] <- broom::tidy(ttest)
}
}
}
comparison_results <- bind_rows(comparison_results, .id="Metric_Day")
View(comparison_results)
# How many samples per Metric, Day, TreatmentGroup
df_long %>%
group_by(Metric, DayPlot, TreatmentGroup) %>%
summarise(n = n(), .groups = "drop") %>%
arrange(Metric, DayPlot, TreatmentGroup)
# EF5 slopes
ef5_slopes_debug <- df_long %>%
filter(TreatmentGroup == "EF5") %>%
group_by(Metric, SphereSimpleID, DayPlot) %>%
summarise(Slope = coef(lm(Value ~ Bin))[2], .groups = "drop")
ef5_slopes_debug %>% head()
# Vehicle slopes
vehicle_slopes_debug <- df_long %>%
filter(TreatmentGroup == "Vehicle") %>%
group_by(Metric, SphereSimpleID) %>%
summarise(Slope = coef(lm(Value ~ Bin))[2], .groups = "drop") %>%
mutate(DayPlot = "Vehicle")
vehicle_slopes_debug %>% head()
# Example for Day 7 and Metric = "FracAtD"
df_treat <- ef5_slopes_debug %>% filter(DayPlot == "Day 7", Metric == "FracAtD")
df_vehicle <- vehicle_slopes_debug %>% filter(Metric == "FracAtD")
df_sub <- bind_rows(df_treat, df_vehicle)
df_sub$TreatmentGroup <- factor(df_sub$TreatmentGroup, levels = c("Vehicle", "EF5"))
df_long %>%
filter(TreatmentGroup == "EF5") %>%
select(FileName_Brightfield, Day, DayPlot, TreatmentGroup) %>%
unique()
# ================================================================
# Corrected Spheroid Fluorescence Intensity Analysis Script
# ================================================================
# -----------------------------
# Load packages
# -----------------------------
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(readxl)
library(purrr)
library(broom)
# -----------------------------
# Set working directory
# -----------------------------
setwd("C:/Users/jps558/OneDrive - University of York/Desktop/R_WorkingDirectory/R_WFHDirectory/spheroids/CellProfiler/EF5 staining")
# -----------------------------
# Read data
# -----------------------------
df <- read_excel("EF5 Intensity from core_NoAmilorideSpheroidMaskAmilorideremoved.xlsx", sheet = 1)
# -----------------------------
# Select relevant columns
# -----------------------------
df_selected <- df %>%
select(
FileName_Brightfield,
matches("^RadialDistribution_(FracAtD|MeanFrac)_Fluorescence_[1-6]of6$")
)
# -----------------------------
# Reshape to long format
# -----------------------------
df_long <- df_selected %>%
pivot_longer(
cols = -FileName_Brightfield,
names_to = c("Metric", "Bin"),
names_pattern = "RadialDistribution_(.*)_Fluorescence_([1-6])of6",
values_to = "Value"
) %>%
mutate(Bin = as.integer(Bin))
# -----------------------------
# Extract sphere & treatment info
# -----------------------------
df_long <- df_long %>%
mutate(
SphereRaw = str_extract(FileName_Brightfield, "Sphere\\d+(_\\d+)?"),
SphereNum = ifelse(str_detect(SphereRaw, "_"),
str_extract(SphereRaw, "(?<=_)\\d+"), "1"),
ImageExportNum = str_extract(FileName_Brightfield, "Image Export-\\d+"),
SphereID = paste0(SphereRaw, "_", ImageExportNum),
# Identify treatments
TreatmentGroup = case_when(
str_detect(FileName_Brightfield, "Vehicle") ~ "Vehicle",
str_detect(FileName_Brightfield, "DMSO") ~ "DMSO",
TRUE ~ "EF5"
),
# Extract EF5 day numbers
EF5DayMatch = str_extract(FileName_Brightfield, "EF5Day\\d+"),
DayNum = as.integer(str_extract(EF5DayMatch, "\\d+")),
Day = ifelse(!is.na(DayNum), paste0("Day ", DayNum), NA_character_),
# For plotting: DayPlot column with Vehicle labeled
DayPlot = ifelse(TreatmentGroup == "Vehicle", "Vehicle", Day),
DayPlot = factor(DayPlot, levels = c("Vehicle", "Day 7","Day 9","Day 11","Day 13"))
)
# -----------------------------
# Assign simple sphere IDs
# -----------------------------
df_long <- df_long %>%
group_by(Metric, Day) %>%
mutate(SphereSimpleID = factor(match(SphereID, unique(SphereID)))) %>%
ungroup()
# -----------------------------
# Calculate slopes
# -----------------------------
# EF5 slopes per sphere/day
ef5_slopes <- df_long %>%
filter(TreatmentGroup == "EF5") %>%
group_by(Metric, SphereSimpleID, DayPlot) %>%
summarise(Slope = coef(lm(Value ~ Bin))[2], .groups = "drop") %>%
mutate(TreatmentGroup = "EF5")
# Vehicle slopes per sphere (pooled across all days)
vehicle_slopes <- df_long %>%
filter(TreatmentGroup == "Vehicle") %>%
group_by(Metric, SphereSimpleID) %>%
summarise(Slope = coef(lm(Value ~ Bin))[2], .groups = "drop") %>%
mutate(DayPlot = "Vehicle",
TreatmentGroup = "Vehicle")
# Combine EF5 and Vehicle slopes
slopes_df <- bind_rows(ef5_slopes, vehicle_slopes)
# -----------------------------
# Statistical comparisons: EF5 day vs pooled Vehicle
# -----------------------------
comparison_results <- list()
metrics <- unique(slopes_df$Metric)
ef5_days <- c("Day 7","Day 9","Day 11","Day 13")
for(metric in metrics){
for(day in ef5_days){
df_treat <- slopes_df %>%
filter(Metric == metric,
TreatmentGroup == "EF5",
DayPlot == day)
df_vehicle <- slopes_df %>%
filter(Metric == metric,
TreatmentGroup == "Vehicle")
if(nrow(df_treat) > 0 & nrow(df_vehicle) > 0){
df_sub <- bind_rows(df_treat, df_vehicle)
df_sub$TreatmentGroup <- factor(df_sub$TreatmentGroup, levels=c("Vehicle","EF5"))
ttest <- t.test(Slope ~ TreatmentGroup, data=df_sub)
est <- setNames(as.numeric(ttest$estimate), levels(df_sub$TreatmentGroup))
comparison_results[[paste(metric, day)]] <- data.frame(
Metric = metric,
Day = day,
estimate_vehicle = est["Vehicle"],
estimate_EF5 = est["EF5"],
estimate_diff = est["EF5"] - est["Vehicle"],
conf.low = ttest$conf.int[1],
conf.high = ttest$conf.int[2],
statistic = ttest$statistic,
p.value = ttest$p.value
)
}
}
}
comparison_results <- bind_rows(comparison_results)
write.csv(comparison_results, "Slope_Comparison_vs_PooledVehicle.csv", row.names = FALSE)
# -----------------------------
# Plot slopes per metric
# -----------------------------
plot_width <- 6
plot_height <- 5
plot_dpi <- 300
for(metric in unique(slopes_df$Metric)){
p <- ggplot(slopes_df %>% filter(Metric == metric),
aes(x = DayPlot, y = Slope, fill = TreatmentGroup)) +
geom_boxplot(alpha = 0.5, outlier.shape = NA,
position = position_dodge(width = 0.7)) +
geom_jitter(aes(color = TreatmentGroup),
position = position_jitterdodge(jitter.width = 0.15,
dodge.width = 0.7),
size = 2, alpha = 0.7) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(title = paste("Slope of", metric, "across Days"),
y = "Slope (Value ~ Bin)",
x = "Day / Vehicle") +
theme_minimal() +
theme(legend.position = "top")
ggsave(filename = paste0("EF5_Slopes_", metric, ".tiff"),
plot = p,
width = plot_width,
height = plot_height,
dpi = plot_dpi)
}
unique(df_long$FileName_Brightfield)
# Load necessary packages
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(broom)
library(readxl)
# Set working directory
setwd("C:/Users/jps558/OneDrive - University of York/Desktop/R_WorkingDirectory/R_WFHDirectory/spheroids/CellProfiler/EF5 staining")
# Read the Excel file (specify the sheet if needed)
df <- read_excel("EF5 Intensity from core_NoAmilorideSpheroidMaskAmilorideremoved.xlsx",
sheet = 1)  # or use the sheet name instead of 1
# Select relevant columns
df_selected <- df %>%
select(
FileName_Brightfield,
matches("^RadialDistribution_(FracAtD|MeanFrac)_Fluorescence_[1-6]of6$")
)
# Pivot to long format
df_long <- df_selected %>%
pivot_longer(
cols = -FileName_Brightfield,
names_to = c("Metric", "Bin"),
names_pattern = "RadialDistribution_(.*)_Fluorescence_([1-6])of6",
values_to = "Value"
) %>%
mutate(Bin = as.integer(Bin))
# Extract sphere & treatment info
df_long <- df_long %>%
mutate(
SphereRaw = str_extract(FileName_Brightfield, "Sphere\\d+(_\\d+)?"),
SphereNum = ifelse(str_detect(SphereRaw, "_"),
str_extract(SphereRaw, "(?<=_)\\d+"), "1"),
ImageExportNum = str_extract(FileName_Brightfield, "Image Export-\\d+"),
SphereID = paste0(SphereRaw, "_", ImageExportNum),
IsDMSO = str_starts(FileName_Brightfield, "DMSO_"),
PrimaryCompound = ifelse(IsDMSO, "DMSO", "EF5"),
SecondaryCompound = ifelse(IsDMSO, "EF5", NA_character_),
TreatmentGroup = ifelse(is.na(SecondaryCompound), PrimaryCompound,
paste(PrimaryCompound, SecondaryCompound, sep = "+")),
CleanTreatmentGroup = TreatmentGroup,
EF5DayMatch = str_extract(FileName_Brightfield, "EF5Day\\d+(-\\d+)?"),
DayNum = as.integer(str_extract(EF5DayMatch, "(?<=EF5Day)\\d+")),
Day = factor(paste0("Day ", DayNum), levels = c("Day 7", "Day 9", "Day 11", "Day 13"))
)
# Assign a simple numeric ID to each sphere per metric/day
df_long <- df_long %>%
group_by(Metric, Day) %>%
mutate(SphereSimpleID = factor(match(SphereID, unique(SphereID)))) %>%
ungroup()
# -----------------------------
# Parameters for saving plots
# -----------------------------
plot_width <- 6      # inches
plot_height <- 5     # inches
plot_dpi <- 300      # resolution
metrics <- c("FracAtD", "MeanFrac")
days <- c(7, 9, 11, 13)
# -----------------------------
# Individual-day plots
# -----------------------------
for (metric in metrics) {
for (day in days) {
p <- ggplot(df_long %>% filter(Metric == metric, DayNum == day),
aes(x = Bin, y = Value, group = SphereSimpleID, color = SphereSimpleID)) +
geom_line() +
labs(title = paste("EF5 -", metric, "- Day", day),
x = "Bin (Distance from Center)",
y = metric) +
theme_minimal() +
theme()
ggsave(filename = paste0("EF5_", metric, "_Day", day, ".tiff"),
plot = p,
width = plot_width,
height = plot_height,
dpi = plot_dpi)
}
}
# -----------------------------
# Faceted plots across days
# -----------------------------
for (metric in metrics) {
p <- ggplot(df_long %>% filter(Metric == metric),
aes(x = Bin, y = Value, group = SphereSimpleID, color = as.factor(DayNum))) +
geom_line(alpha = 0.7) +
facet_wrap(~Day) +
labs(title = paste("EF5 -", metric, "across Days 7, 9, 11, 13"),
x = "Bin (Distance from Center)",
y = metric,
color = "Day") +
theme_minimal() +
theme(legend.position = "none")
ggsave(filename = paste0("EF5_", metric, "_Faceted.tiff"),
plot = p,
width = plot_width * 1.5,
height = plot_height,
dpi = plot_dpi)
}
# -----------------------------
# Faceted plots across EF5 days + Vehicle with trend lines
# -----------------------------
for (metric in metrics) {
p <- ggplot(df_long %>% filter(Metric == metric),
aes(x = Bin, y = Value, group = SphereSimpleID, color = Day)) +
geom_line(alpha = 0.6) +
# add trend line per facet (linear regression fit)
geom_smooth(aes(group = 1), method = "lm", se = TRUE, color = "black", linetype = "dashed") +
facet_wrap(~Day) +
labs(title = paste("EF5 + Vehicle -", metric, "across Days (with trend lines)"),
x = "Bin (Distance from Center)",
y = metric,
color = "Group") +
theme_minimal()
ggsave(filename = paste0("EF5_Vehicle_", metric, "_Faceted_withTrend.tiff"),
plot = p,
width = plot_width * 1.5,
height = plot_height,
dpi = plot_dpi)
}
# -----------------------------
# Slope calculation per sphere
# -----------------------------
slopes_df <- df_long %>%
group_by(Metric, Day, SphereSimpleID) %>%
do(tidy(lm(Value ~ Bin, data = .))) %>%
filter(term == "Bin") %>%
rename(Slope = estimate,
Slope_SE = std.error,
Slope_t = statistic,
Slope_p = p.value) %>%
ungroup()
# Summarize slopes across spheres
slopes_summary <- slopes_df %>%
group_by(Metric, Day) %>%
summarise(
Mean_Slope = mean(Slope),
SD_Slope = sd(Slope),
N = n(),
t_test_p = t.test(Slope)$p.value
)
# Add significance labels
slopes_summary <- slopes_summary %>%
mutate(SignifLabel = ifelse(t_test_p < 0.001, "***",
ifelse(t_test_p < 0.01, "**",
ifelse(t_test_p < 0.05, "*", "ns"))))
# -----------------------------
# Slope boxplot with significance
# -----------------------------
p_slopes <- ggplot(slopes_df, aes(x = Day, y = Slope, fill = Metric)) +
geom_boxplot(alpha = 0.5, outlier.shape = NA, position = position_dodge(width = 0.8)) +
geom_jitter(aes(color = Metric),
position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.8),
size = 2, alpha = 0.7) +
geom_hline(yintercept = 0, linetype = "dashed") +
geom_text(data = slopes_summary,
aes(x = Day, y = max(slopes_df$Slope) + 0.05, label = SignifLabel, group = Metric),
position = position_dodge(width = 0.8),
vjust = 0) +
labs(title = "Slope of EF5 Metric across Bins per Sphere",
y = "Slope (Value ~ Bin)",
x = "Day") +
theme_minimal() +
theme(legend.position = "top")
# Save as TIFF
ggsave(filename = "EF5_Slopes_Boxplot_withPoints.tiff",
plot = p_slopes,
width = 9,
height = 5,
dpi = 300)
# ================================================================
# Spheroid Fluorescence Intensity Analysis
# ================================================================
# -----------------------------
# Load packages
# -----------------------------
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(broom)
library(readxl)
library(purrr)
# -----------------------------
# Set working directory
# -----------------------------
setwd("C:/Users/jps558/OneDrive - University of York/Desktop/R_WorkingDirectory/R_WFHDirectory/spheroids/CellProfiler/EF5 staining")
# -----------------------------
# Read data
# -----------------------------
df <- read_excel("EF5 Intensity from core_NoAmilorideSpheroidMaskAmilorideremoved.xlsx", sheet = 1)
# -----------------------------
# Select relevant columns
# -----------------------------
df_selected <- df %>%
select(
FileName_Brightfield,
matches("^RadialDistribution_(FracAtD|MeanFrac)_Fluorescence_[1-6]of6$")
)
# -----------------------------
# Pivot to long format
# -----------------------------
df_long <- df_selected %>%
pivot_longer(
cols = -FileName_Brightfield,
names_to = c("Metric", "Bin"),
names_pattern = "RadialDistribution_(.*)_Fluorescence_([1-6])of6",
values_to = "Value"
) %>%
mutate(Bin = as.integer(Bin))
# -----------------------------
# Extract sphere & treatment info
# -----------------------------
df_long <- df_long %>%
mutate(
SphereRaw = str_extract(FileName_Brightfield, "Sphere\\d+(_\\d+)?"),
SphereNum = ifelse(str_detect(SphereRaw, "_"),
str_extract(SphereRaw, "(?<=_)\\d+"), "1"),
ImageExportNum = str_extract(FileName_Brightfield, "Image Export-\\d+"),
SphereID = paste0(SphereRaw, "_", ImageExportNum),
# Identify Vehicle, DMSO, EF5
IsVehicle = str_detect(FileName_Brightfield, "Vehicle"),
IsDMSO = str_detect(FileName_Brightfield, "DMSO"),
TreatmentGroup = case_when(
IsVehicle ~ "Vehicle",
IsDMSO ~ "DMSO",
TRUE ~ "EF5"
),
EF5DayMatch = str_extract(FileName_Brightfield, "EF5Day\\d+(-\\d+)?"),
DayNum = as.integer(str_extract(EF5DayMatch, "(?<=EF5Day)\\d+")),
Day = factor(paste0("Day ", DayNum), levels = c("Day 7", "Day 9", "Day 11", "Day 13"))
)
# -----------------------------
# Assign numeric ID per sphere
# -----------------------------
df_long <- df_long %>%
group_by(Metric, Day) %>%
mutate(SphereSimpleID = factor(match(SphereID, unique(SphereID)))) %>%
ungroup()
# -----------------------------
# Slope calculation per sphere
# -----------------------------
slopes_df <- df_long %>%
group_by(Metric, Day, SphereSimpleID, TreatmentGroup) %>%
do(tidy(lm(Value ~ Bin, data = .))) %>%
filter(term == "Bin") %>%
rename(Slope = estimate,
Slope_SE = std.error,
Slope_t = statistic,
Slope_p = p.value) %>%
ungroup()
# -----------------------------
# T-tests: EF5 & DMSO vs Vehicle
# -----------------------------
vehicle_name <- "Vehicle"
metrics <- unique(slopes_df$Metric)
days <- unique(slopes_df$Day)
treatments <- setdiff(unique(slopes_df$TreatmentGroup), vehicle_name)
comparison_results <- list()
for (metric in metrics) {
for (day in days) {
for (treat in treatments) {
df_sub <- slopes_df %>%
filter(Metric == metric,
Day == day,
TreatmentGroup %in% c(vehicle_name, treat))
if(length(unique(df_sub$TreatmentGroup)) == 2) {
ttest <- t.test(Slope ~ TreatmentGroup, data = df_sub)
comparison_results <- append(comparison_results,
list(data.frame(
Metric = metric,
Day = day,
Treatment = treat,
estimate_vehicle = ttest$estimate[vehicle_name],
estimate_treatment = ttest$estimate[treat],
estimate_diff = unname(diff(rev(ttest$estimate))),
conf.low = ttest$conf.int[1],
conf.high = ttest$conf.int[2],
statistic = ttest$statistic,
p.value = ttest$p.value
)))
}
}
}
}
comparison_results <- bind_rows(comparison_results)
# Save results
write.csv(comparison_results, "Slope_Comparison_vs_Vehicle.csv", row.names = FALSE)
# -----------------------------
# Plot slopes (separate plots per metric)
# -----------------------------
plot_width <- 6
plot_height <- 5
plot_dpi <- 300
for (metric in unique(slopes_df$Metric)) {
p <- ggplot(slopes_df %>% filter(Metric == metric),
aes(x = Day, y = Slope, fill = TreatmentGroup)) +
geom_boxplot(alpha = 0.5, outlier.shape = NA,
position = position_dodge(width = 0.7)) +
geom_jitter(aes(color = TreatmentGroup),
position = position_jitterdodge(jitter.width = 0.15,
dodge.width = 0.7),
size = 2, alpha = 0.7) +
geom_hline(yintercept = 0, linetype = "dashed") +
labs(title = paste("Slope of", metric, "across Days"),
y = "Slope (Value ~ Bin)",
x = "Day") +
theme_minimal() +
theme(legend.position = "top")
ggsave(filename = paste0("EF5_Slopes_", metric, ".tiff"),
plot = p,
width = plot_width,
height = plot_height,
dpi = plot_dpi)
}
View(comparison_results)
View(df_long)
View(slopes_df)
