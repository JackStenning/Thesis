#!/bin/bash
#SBATCH --job-name=samtosortedbedgraph   # Job name
#SBATCH --mail-type=END,FAIL             # Mail events (NONE, BEGIN, END, FAIL, ALL)
#SBATCH --mail-user=jps558@york.ac.uk    # Where to send mail  
#SBATCH --ntasks=4                       # Run on a single CPU
#SBATCH --mem=70gb                       # Job memory request
#SBATCH --time=05:00:00                  # Time limit hrs:min:sec
#SBATCH --output=basic_job_%j.log        # Standard output and error log
#SBATCH --account=biol-hic-2020          # Project account

#Purge exisiting modules to prevent conflict
#Begin processing from .fastq to sam, from .sam to .bam - sorting, indexing, making bedgraph and followed by conversion to bigwig

####### NOTE CHECK WHICH GENOME SHOULD BE USED #######

######## This script is only applicable for hg38 alignments ########

module purge
module load bio/deepTools/3.5.1-foss-2021b
module load bio/BWA/0.7.17-foss-2019b
module load bio/SAMtools/1.9-foss-2018b
module load bio/BEDTools/2.30.0-GCC-11.2.0

	gunzip workingChipdata/HCT116_SP1/Input/ENCFF000PBY.fastq.gz
	bwa mem -p -t 40 /mnt/lustre/groups/biol-hic-2020/jack/staging/hg38/hg38.fa workingChipdata/HCT116_SP1/Input/ENCFF000PBY.fastq > workingChipdata/HCT116_SP1/Input/ENCFF000PBY_aligned.sam
	samtools view -S -b workingChipdata/HCT116_SP1/Input/ENCFF000PBY_aligned.sam > workingChipdata/HCT116_SP1/Input/ENCFF000PBY.bam
	samtools sort workingChipdata/HCT116_SP1/Input/ENCFF000PBY.bam -o workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted_hg38.bam
	samtools index workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted_hg38.bam
	bedtools genomecov -ibam workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted_hg38.bam -bg -scale 35 > workingChipdata/HCT116_SP1/Input/ENCFF000PBY_hg38.bedgraph
	sort -k1,1 -k2,2n workingChipdata/HCT116_SP1/Input/ENCFF000PBY_hg38.bedgraph > workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted.bedgraph
	module purge
	module load bio/Kent_tools/407-gompi-2020a
	bedGraphToBigWig workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted.bedgraph  https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes workingChipdata/HCT116_SP1/Input/ENCFF000PBY.bw
	cp workingChipdata/HCT116_SP1/Input/ENCFF000PBY.bw /mnt/lustre/groups/biol-hic-2020/jack/processedChipdata/20230621/HCT116_SP1/Input/ENCFF000PBY.bw
	cp workingChipdata/HCT116_SP1/Input/ENCFF000PBY_sorted.bedgraph /mnt/lustre/groups/biol-hic-2020/jack/processedChipdata/20230621/HCT116_SP1/Input/ENCFF000PBY_sorted.bedgraph
	done





