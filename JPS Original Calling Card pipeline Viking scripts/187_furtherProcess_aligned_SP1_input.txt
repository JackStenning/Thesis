#!/bin/bash
#SBATCH --job-name=ChIP_additional_process	# Job name
#SBATCH --mail-type=END,FAIL             # Mail events (NONE, BEGIN, END, FAIL, ALL)
#SBATCH --mail-user=jps558@york.ac.uk    # Where to send mail  
#SBATCH --ntasks=1                       # Run on a single CPU
#SBATCH --mem=30gb                       # Job memory request
#SBATCH --time=01:30:00                  # Time limit hrs:min:sec
#SBATCH --output=basic_job_%j.log        # Standard output and error log
#SBATCH --account=biol-hic-2020          # Project account
#SBATCH --partition=preempt

#re-load needed modules for remaining pro
module purge
module load bio/deepTools/3.5.1-foss-2021b
module load bio/BEDTools/2.30.0-GCC-11.2.0

cd /mnt/lustre/groups/biol-hic-2020/jack/workingChipdata

#Code to process the sample files for SP1 and BRD4 in HCT
for dir in HCT*; do
	cd "$dir"
	for file in *_filtered_sorted.bed; do
		module purge
		module load bio/deepTools/3.5.1-foss-2021b
		module load bio/BEDTools/2.30.0-GCC-11.2.0
		bedtools genomecov -i "$file" -bg -g /mnt/lustre/groups/biol-hic-2020/jack/staging/hg38/hg38.chrom.sizes > "$file".bedgraph
		sort -k1,1 -k2,2n "$file".bedgraph > "$file"_sorted.bedgraph
		module purge
		module load bio/Kent_tools/407-gompi-2020a
		bedGraphToBigWig "$file"_sorted.bedgraph https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes "$file".bw
		cp "$file"_sorted.bedgraph ../../processedChipdata/20230816_HCT_filtered/
		cp "$file".bw ../../processedChipdata/20230816_HCT_filtered/
		cd /mnt/lustre/groups/biol-hic-2020/jack/workingChipdata
		done
	done
#Code to process the SP1 input only, as the BRD4 alignment is stopped due to viking restrictions
cd /mnt/lustre/groups/biol-hic-2020/jack/workingChipdata/HCT116_SP1/Input
for file in *_filtered_sorted.bed; do
		module purge
		module load bio/deepTools/3.5.1-foss-2021b
		module load bio/BEDTools/2.30.0-GCC-11.2.0
		bedtools genomecov -i "$file" -bg -g /mnt/lustre/groups/biol-hic-2020/jack/staging/hg38/hg38.chrom.sizes > "$file".bedgraph
		sort -k1,1 -k2,2n "$file".bedgraph > "$file"_sorted.bedgraph
		module purge
		module load bio/Kent_tools/407-gompi-2020a
		bedGraphToBigWig "$file"_sorted.bedgraph https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes "$file".bw
		cp "$file"_sorted.bedgraph ../../../processedChipdata/20230816_HCT_filtered/
		cp "$file".bw ../../../processedChipdata/20230816_HCT_filtered/
		done 
cd /mnt/lustre/groups/biol-hic-2020/jack/workingCCdata/HCT-116_WT_HyPB_PB_+-SP1