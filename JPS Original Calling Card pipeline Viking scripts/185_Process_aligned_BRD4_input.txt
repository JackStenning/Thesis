#!/bin/bash
#SBATCH --job-name=aligned_BRD4processing	# Job name
#SBATCH --mail-type=END,FAIL             # Mail events (NONE, BEGIN, END, FAIL, ALL)
#SBATCH --mail-user=jps558@york.ac.uk    # Where to send mail  
#SBATCH --ntasks=1                       # Run on a single CPU
#SBATCH --mem=30gb                       # Job memory request
#SBATCH --time=01:30:00                  # Time limit hrs:min:sec
#SBATCH --output=basic_job_%j.log        # Standard output and error log
#SBATCH --account=biol-hic-2020          # Project account
#SBATCH --partition=preempt
module purge
module load bio/deepTools/3.5.1-foss-2021b
module load bio/BWA/0.7.17-foss-2019b
module load bio/SAMtools/1.9-foss-2018b
module load bio/BEDTools/2.30.0-GCC-11.2.0
cd /mnt/lustre/groups/biol-hic-2020/jack/workingChipdata/HCT116_Brd4/input

samtools view -S -b SRR2481800_aligned.sam > SRR2481800.bam
samtools sort SRR2481800.bam -o SRR2481800_sorted_hg38.bam
samtools index SRR2481800_sorted_hg38.bam

#Converting to bed in order to filter
bedtools bamtobed -i SRR2481800_sorted_hg38.bam > SRR2481800_hg38.bed
sort -k 1,1 SRR2481800_hg38.bed > SRR2481800_hg38_sorted.bed
#Filtering out blacklist sites
module purge
module load bio/BEDOPS/2.4.37-foss-2018b
bedops -n -1 SRR2481800_hg38_sorted.bed /mnt/lustre/groups/biol-hic-2020/jack/staging/hg38/Blacklist/hg38-blacklist.v2.bed > SRR2481800_hg38_filtered_sorted.bed

#re-load needed modules for remaining pro
module purge
module load bio/deepTools/3.5.1-foss-2021b
module load bio/BEDTools/2.30.0-GCC-11.2.0

bedtools genomecov -bg -i SRR2481800_hg38_filtered_sorted.bed -g /mnt/lustre/groups/biol-hic-2020/jack/staging/hg38/hg38.chrom.sizes > SRR2481800_hg38.bedgraph
sort -k1,1 -k2,2n SRR2481800_hg38.bedgraph > SRR2481800_sorted.bedgraph
module purge
module load bio/Kent_tools/407-gompi-2020a
bedGraphToBigWig SRR2481800_sorted.bedgraph https://hgdownload.soe.ucsc.edu/goldenPath/hg38/bigZips/hg38.chrom.sizes SRR2481800.bw

cd /mnt/lustre/groups/biol-hic-2020/jack/workingCCdata/HCT-116_WT_HyPB_PB_+-SP1